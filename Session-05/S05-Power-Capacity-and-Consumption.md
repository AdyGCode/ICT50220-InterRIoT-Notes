---
theme: default
paginate: true
footer: © Copyright 2024, Adrian Gould & NM TAFE
header: "![NMTAFE](../images/Black-Red-Banner.svg)"
auto-scaling: true
size: 4k
color: "#ccc"
backgroundColor: "#060606"
tags: 
  - Internet of Things
  - InterRIoT
  - IoT
  - Robotics
  - Python
  - Arduino
  - ESP-32
  - C
  - C++

date created: 03 July 2024
date modified: 10 July 2024
---

# Batteries and their Capacity

Batteries come in all sorts of shapes and sizes. They can be just a few mm across to measuring metres across, depending on the type adn application.

For most IoT systems we use low power batteries such as 1.V AA alkaline cells, 3.3V button cells, 12V lead-acid cells, and of course, our Nickle-Cadmium and Lithium-Ion/Polymer rechargeable cells.

Either way you need to know their capacity.

For the discussion below, we will concentrate on rechargeable cells.

> **Note:**
> The information below is very simplified, as the concepts and the ability to perform approximations is more important than having an understanding at the deep physics and chemistry level.

## Capacity

When you purchase a Lithium-Polymer (LiPo) or Nickle-Cadmium (NiCad) you will find they are labelled with a value in mAh.

### What is mAh?

mAh stands for milli-Amp Hours.

It is a measurement of the amount of current the battery may supply for in one hour at full power drain.

This means a 1000 mAh battery may supply 1 Amp for 1 hour.

These batteries, though are unable to supply that amount of power all the time, and in fact, the value stated is the "ideal" value. Batteries tend to supply less power, and with each recharge, they loose some of this capacity.

Most batteries will only be able to recharge to a percentage of their maximum value. This degrades over time.

Most batteries also will supply current that is not a full exhaustion of the capacity of the device, as the underlying chemistry limits this.

Given this we say:
- A battery has a maximum theoretical capacity (e.g. 1000 mAh) - we shall express this as `MaxCap`
- A battery may supply until its capacity is a minimum value (eg. 100 mAh) - we shall express this as `MinCap`
- A battery may only recharge to an average of 80% of total capacity over its lifetime - we shall express this as `AvgPerc`

Given this, we may use the following to calculate the "approximate actual capacity":

> `Actual Capacity = (MaxCap - MinCap) × AvgPerc`

Here is a table showing some calculations using this:

| Max Cap | Min Cap | Avg Perc | Calc                         | Actual Cap |
| ------- | ------- | -------- | ---------------------------- | ---------- |
| 1000    | 100     | 85%      | (1000 - 100) * 85 / 100      | 765 mAh    |
| 12,000  | 2500    | 87.5%    | (12000 - 2500) * 87.5 / 100* | 8312.5 mAh |


# How Much Power do we Consume?

All electronics components consume power.

An MCU is no different.

The following table was generated by ChatGPT and needs to be verified [ChatGPT Transcript](https://chatgpt.com/share/7c9ab9db-0142-45de-ba15-d1e69bdb606c).

| **MCU**                     | **Operating** | **Recommended Input** | **GPIO Pin Voltage** | **GPIO Pin Current Limit** | **Total Current Limit (All GPIOs)** |
| --------------------------- | ------------- | --------------------- | -------------------- | -------------------------- | ----------------------------------- |
| **Arduino <br>Uno R3**      | 5V            | 7 - 12V               | 5V                   | 20-40 mA per pin           | 200 mA                              |
| **Arduino <br>Uno R4**      | 5V            | 7 - 12V               | 5V                   | 20-40 mA per pin           | 200 mA                              |
| **ESP32-WROVER**            | 3.3V          | 3.0 - 3.6V            | 3.3V                 | 40 mA per pin              | 120 mA                              |
| **Raspberry <br>Pi Pico W** | 3.3V          | 5V (via USB)          | 3.3V                 | 12 mA per pin              | 50 mA                               |

These details need to be taken into account when calculating the running time of a device when using battery based power.

These values do not take into account other MCU capabilities such as Bluetooth, Wi-Fi and so on.

# Calculating Battery Lifetime

When developing a IoT device, and that device will be driven by a battery, then you need to calculate the approximate lifetime of the supply.

So how do we calculate the running time for an IoT Device that is powered by battery?

We will look at the theoretical max duration and the average lifetime based duration.

## Theoretical Max Duration

To calculate this we use:

> `Duration = Max Capacity ÷ Average Current Drawn`

Here are some sample calculations:

| Max Cap | Average Current Draw | Calc         | Duration  |
| ------- | -------------------- | ------------ | --------- |
| 1000    | 100                  | 1000 / 100   | 100 Hours |
| 12,000  | 1250                 | 12000 / 1250 | 9.6 Hours |

## Approximate "Real" Durations"

The approximate "real" duration will use the "Actual" capacity fo the battery.

This results in the following expression:

> `"Real" Duration = (MaxCap - MinCap) × AvgPerc ÷ Average Current Drawn` 

Again some example calculations


| Max Cap | Min Cap | Avg Perc | Avg Current | Calc                                 | Approx' Duration              |
| ------- | ------- | -------- | ----------- | ------------------------------------ | ----------------------------- |
| 1000    | 100     | 85%      | 150 mA      | (1000 - 100) × 85 ÷ (100 * 150)      | 5.1 Hours<br>(5h 6m)          |
| 12,000  | 2500    | 87.5%    | 1050 mA     | (12000 - 2500) × 87.5 ÷ (100 × 1050) | 40.375 Hours<br>(40h 22m 30s) |


# Average Power Consumption

Whilst we have yet to discuss the different modes that MCUs have, we are still able discuss the concept of average power consumption.

Let's take the example of the IoT Hello World, also known as the LED Flasher Circuit.

If the circuit and the MCU's code has the following details:
- LED (Red), 15mA at 3.3V
- Resistor 330Ω
- ESP32, 250mA (All GPIO and all API modules), ~20mA (1 GPIO on, no API modules)
  **NOTE:** these are "guestimates" for the purpose of illustration.
- LED on for 1 second, off for 1 second
- Battery 1000 mAh

We are able to work out the average power consumption per minute.

Start off with the power consumption for the ESP32 with only one GPIO active, and no additional modules.

- ESP32 = ~5mA

When the LED is on, the values are:
- ESP32 + LED = ~20mA

So what about the power consumption?

Average power per second
- = ( 1 x 20 + 1 x 5) / 2
- = 25 / 2
- = 12.5 mA

Avg Power per hour
- = 12.5 x 3600
- = 45000 mA

Duration = capacity / Power used per hour
- = 1000 / 45000
- = 0.053 hrs
- = 1.33 mins
- = 1 min 20 sec


# Unequal On/Off times

We will use the same details as above, but the on time will be 1 second and the Off time will be 60 seconds.

Average Power per second
- = (On time x on Current + off time x off current) / total time
- = (1 x 20 + 60 x 5) / 61
- = 320 / 61 
- = 5.25 mA

Average power per hour
- = 5.25 x 3600
- = 18885 mA

Duration = capacity / average power per hour
- = 1000 / 18885
- = 0.053 hrs
- = 3.18 mins
- = 3 mins 10 sec


[Back to Session 04...](ReadMe.md)
